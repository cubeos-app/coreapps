stages:
  - validate
  - deploy
  - restart

variables:
  CUBEOS_SUBNET: "10.42.24.0/24"
  CUBEOS_GATEWAY: "10.42.24.1"
  CUBEOS_DOMAIN: "cubeos.cube"

validate-compose:
  stage: validate
  image: registry-gitlab.nuclearlighters.net/products/cubeos/coreapps/ci-utils:latest
  tags:
    - multiarch
  script:
    - |
      # Create dummy env files for validation (real files are on Pi)
      mkdir -p /cubeos/config
      touch /cubeos/config/defaults.env
      touch /cubeos/config/secrets.env
      
      for dir in */; do
        if [ -f "${dir}appconfig/docker-compose.yml" ]; then
          echo "Checking ${dir}..."
          docker compose -f "${dir}appconfig/docker-compose.yml" config -q || exit 1
        fi
      done
      echo "‚úÖ All compose files valid"
  rules:
    - if: $CI_COMMIT_BRANCH

shellcheck:
  stage: validate
  image: registry-gitlab.nuclearlighters.net/products/cubeos/coreapps/ci-utils:latest
  tags:
    - multiarch
  script:
    - find . -name "*.sh" -type f -exec shellcheck -x {} \;
  rules:
    - if: $CI_COMMIT_BRANCH
  allow_failure: true

deploy:
  stage: deploy
  tags:
    - deploy
    - arm64
  script:
    - |
      # Detect changed apps
      CHANGED_APPS=""
      if [ "$CI_COMMIT_BEFORE_SHA" != "0000000000000000000000000000000000000000" ]; then
        CHANGED_APPS=$(git diff --name-only "$CI_COMMIT_BEFORE_SHA" "$CI_COMMIT_SHA" 2>/dev/null \
          | grep -E '^[^/]+/(appconfig|src)/' \
          | cut -d'/' -f1 \
          | sort -u \
          | tr '\n' ' ' \
          | sed 's/ $//' || true)
      fi
      
      # Fallback: if no changes detected but this is a new commit, check all dirs
      if [ -z "$CHANGED_APPS" ]; then
        echo "‚ö†Ô∏è  No changes detected via git diff, checking for new apps..."
        for dir in */; do
          app="${dir%/}"
          if [ -d "${dir}appconfig" ] && [ ! -d "/cubeos/coreapps/${app}" ]; then
            CHANGED_APPS="$CHANGED_APPS $app"
          fi
        done
        CHANGED_APPS=$(echo "$CHANGED_APPS" | xargs)
      fi
      
      echo "üì¶ Changed apps: ${CHANGED_APPS:-none}"
      
      # Sync ALL configs and source (idempotent)
      for dir in */; do
        if [ -d "${dir}appconfig" ]; then
          mkdir -p "/cubeos/coreapps/${dir}appconfig"
          mkdir -p "/cubeos/coreapps/${dir}appdata"
          rsync -a --delete "${dir}appconfig/" "/cubeos/coreapps/${dir}appconfig/"
          
          # Also sync src/ if it exists (for buildable apps)
          if [ -d "${dir}src" ]; then
            mkdir -p "/cubeos/coreapps/${dir}src"
            rsync -a --delete "${dir}src/" "/cubeos/coreapps/${dir}src/"
          fi
          
          # Sync appdata if it exists (for DNS configs, etc)
          if [ -d "${dir}appdata" ]; then
            rsync -a "${dir}appdata/" "/cubeos/coreapps/${dir}appdata/"
          fi
        fi
      done
      
      # Sync defaults.env
      [ -f defaults.env ] && cp defaults.env /cubeos/coreapps/
      
      # Ensure config directory structure
      mkdir -p /cubeos/config/vpn/{wireguard,openvpn}
      mkdir -p /cubeos/data/registry
      
      # Copy defaults.env to config if not exists
      if [ ! -f /cubeos/config/defaults.env ]; then
        cp defaults.env /cubeos/config/defaults.env
      fi
      
      # Create empty secrets.env if not exists
      if [ ! -f /cubeos/config/secrets.env ]; then
        touch /cubeos/config/secrets.env
        chmod 600 /cubeos/config/secrets.env
      fi
      
      # Sync scripts
      for f in *.sh; do
        [ -f "$f" ] && cp "$f" /cubeos/coreapps/ && chmod +x /cubeos/coreapps/"$f"
      done
      
      # Write changed apps (space-separated)
      echo "$CHANGED_APPS" > changed_apps.txt
      echo "‚úÖ Synced to /cubeos/coreapps/"
  artifacts:
    paths:
      - changed_apps.txt
    expire_in: 10 minutes
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
  environment:
    name: production

restart-changed:
  stage: restart
  tags:
    - deploy
    - arm64
  needs:
    - deploy
  script:
    - |
      set -e
      
      CHANGED_APPS=$(cat changed_apps.txt 2>/dev/null | xargs || true)
      
      if [ -z "$CHANGED_APPS" ]; then
        echo "‚úÖ No app changes detected, skipping restart"
        exit 0
      fi
      
      echo "üîÑ Apps to restart: $CHANGED_APPS"
      
      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      # DNS Health Check - ensure we can resolve Docker Hub
      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      echo "üåê Checking DNS resolution..."
      DNS_OK=false
      for attempt in 1 2 3; do
        if getent hosts registry-1.docker.io >/dev/null 2>&1; then
          DNS_OK=true
          break
        fi
        echo "  DNS attempt $attempt failed, waiting..."
        sleep 5
      done
      
      if [ "$DNS_OK" = "false" ]; then
        echo "‚ùå DNS resolution failed - is Pi-hole running?"
        echo "   Run: cd /cubeos/coreapps/pihole/appconfig && docker compose up -d"
        exit 1
      fi
      echo "  ‚úÖ DNS OK"
      
      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      # Separate pihole from other apps (restart DNS last)
      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      OTHER_APPS=""
      HAS_PIHOLE=false
      
      for app in $CHANGED_APPS; do
        if [ "$app" = "pihole" ]; then
          HAS_PIHOLE=true
        else
          OTHER_APPS="$OTHER_APPS $app"
        fi
      done
      OTHER_APPS=$(echo "$OTHER_APPS" | xargs)
      
      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      # Restart non-pihole apps
      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      for app in $OTHER_APPS; do
        COMPOSE_FILE="/cubeos/coreapps/${app}/appconfig/docker-compose.yml"
        if [ ! -f "$COMPOSE_FILE" ]; then
          echo "‚ö†Ô∏è  Skipping $app (no docker-compose.yml)"
          continue
        fi
        
        echo "‚îÄ‚îÄ $app ‚îÄ‚îÄ"
        cd "/cubeos/coreapps/${app}/appconfig"
        
        # Stop and remove existing container first
        echo "  üõë Stopping existing..."
        docker compose down --remove-orphans 2>/dev/null || true
        
        # Check if this app needs building (has build: section)
        if grep -q "^\s*build:" "$COMPOSE_FILE"; then
          echo "  üî® Building (local Dockerfile)..."
          docker compose build --no-cache 2>&1 || {
            echo "  ‚ùå Build failed!"
            exit 1
          }
        else
          # Pull images first (with timeout)
          echo "  üì• Pulling..."
          timeout 120 docker compose pull 2>&1 || {
            echo "  ‚ö†Ô∏è  Pull failed/timed out, continuing with cached image..."
          }
        fi
        
        # Start fresh
        echo "  üöÄ Starting..."
        docker compose up -d
        
        # Health check (wait up to 30s)
        sleep 3
        CONTAINER=$(docker compose ps -q 2>/dev/null | head -1)
        if [ -n "$CONTAINER" ]; then
          for i in $(seq 1 10); do
            STATUS=$(docker inspect --format='{{.State.Status}}' "$CONTAINER" 2>/dev/null || echo "unknown")
            if [ "$STATUS" = "running" ]; then
              echo "  ‚úÖ $app running"
              break
            fi
            [ "$i" -eq 10 ] && echo "  ‚ö†Ô∏è  $app status: $STATUS (may still be starting)"
            sleep 3
          done
        else
          echo "  ‚úÖ $app started (no main container to check)"
        fi
      done
      
      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      # Restart pihole LAST (if changed)
      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      if [ "$HAS_PIHOLE" = "true" ]; then
        echo ""
        echo "‚îÄ‚îÄ pihole (DNS will briefly drop) ‚îÄ‚îÄ"
        cd "/cubeos/coreapps/pihole/appconfig"
        
        echo "  üõë Stopping existing..."
        docker compose down --remove-orphans 2>/dev/null || true
        
        docker compose pull 2>&1 || true
        docker compose up -d
        
        echo "  Waiting for Pi-hole DNS..."
        for i in $(seq 1 30); do
          if getent hosts google.com >/dev/null 2>&1; then
            echo "  ‚úÖ Pi-hole DNS responding"
            break
          fi
          [ "$i" -eq 30 ] && echo "  ‚ö†Ô∏è  Pi-hole may still be starting..."
          sleep 2
        done
      fi
      
      echo ""
      echo "‚úÖ Restart complete"
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
  environment:
    name: production
