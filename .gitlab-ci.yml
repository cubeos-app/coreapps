stages:
  - validate
  - deploy
  - restart

validate-compose:
  stage: validate
  image: docker:24-cli
  tags:
    - multiarch
  script:
    - |
      for dir in */; do
        if [ -f "${dir}appconfig/docker-compose.yml" ]; then
          echo "Checking ${dir}..."
          docker compose -f "${dir}appconfig/docker-compose.yml" config -q || exit 1
        fi
      done
      echo "âœ… All compose files valid"
  rules:
    - if: $CI_COMMIT_BRANCH

shellcheck:
  stage: validate
  image: koalaman/shellcheck-alpine:stable
  tags:
    - multiarch
  script:
    - find . -name "*.sh" -type f -exec shellcheck -x {} \;
  rules:
    - if: $CI_COMMIT_BRANCH
  allow_failure: true

deploy:
  stage: deploy
  tags:
    - deploy
    - arm64
  script:
    - |
      # Detect changed coreapps
      CHANGED_APPS=""
      if [ "$CI_COMMIT_BEFORE_SHA" != "0000000000000000000000000000000000000000" ]; then
        CHANGED_APPS=$(git diff --name-only $CI_COMMIT_BEFORE_SHA $CI_COMMIT_SHA | grep -E '^[^/]+/appconfig/' | cut -d'/' -f1 | sort -u | tr '\n' ' ')
      fi
      echo "Changed apps: ${CHANGED_APPS:-none detected (full sync)}"
      
      # Sync all appconfig directories
      for dir in */; do
        if [ -d "${dir}appconfig" ]; then
          mkdir -p "/cubeos/coreapps/${dir}appconfig"
          cp -r "${dir}appconfig/"* "/cubeos/coreapps/${dir}appconfig/"
        fi
      done
      
      # Sync scripts
      for f in *.sh; do
        [ -f "$f" ] && cp "$f" /cubeos/coreapps/ && chmod +x /cubeos/coreapps/"$f"
      done
      
      # Save changed apps list for restart stage
      echo "$CHANGED_APPS" > /tmp/changed_apps.txt
      
      echo "âœ… Synced to /cubeos/coreapps/"
  artifacts:
    paths:
      - /tmp/changed_apps.txt
    expire_in: 10 minutes
    when: always
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
  environment:
    name: production

restart-changed:
  stage: restart
  tags:
    - deploy
    - arm64
  script:
    - |
      # Get changed apps from deploy stage or detect from git
      if [ -f /tmp/changed_apps.txt ]; then
        CHANGED_APPS=$(cat /tmp/changed_apps.txt)
      else
        CHANGED_APPS=$(git diff --name-only $CI_COMMIT_BEFORE_SHA $CI_COMMIT_SHA 2>/dev/null | grep -E '^[^/]+/appconfig/' | cut -d'/' -f1 | sort -u | tr '\n' ' ')
      fi
      
      if [ -z "$CHANGED_APPS" ]; then
        echo "No app changes detected, skipping restart"
        exit 0
      fi
      
      echo "ğŸ”„ Restarting changed apps: $CHANGED_APPS"
      
      for app in $CHANGED_APPS; do
        COMPOSE_FILE="/cubeos/coreapps/${app}/appconfig/docker-compose.yml"
        if [ -f "$COMPOSE_FILE" ]; then
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo "Restarting: $app"
          cd "/cubeos/coreapps/${app}/appconfig"
          
          # Down and up
          docker compose down --remove-orphans 2>/dev/null || true
          docker compose up -d
          
          # Wait for container to start
          sleep 5
          
          # Get container name from compose
          CONTAINER=$(docker compose ps -q 2>/dev/null | head -1)
          if [ -n "$CONTAINER" ]; then
            STATUS=$(docker inspect --format='{{.State.Status}}' "$CONTAINER" 2>/dev/null || echo "unknown")
            HEALTH=$(docker inspect --format='{{if .State.Health}}{{.State.Health.Status}}{{else}}no-healthcheck{{end}}' "$CONTAINER" 2>/dev/null || echo "unknown")
            echo "  Container: $CONTAINER"
            echo "  Status: $STATUS"
            echo "  Health: $HEALTH"
            
            if [ "$STATUS" != "running" ]; then
              echo "  âŒ FAILED - container not running"
              docker logs "$CONTAINER" --tail 20
              exit 1
            fi
            echo "  âœ… OK"
          else
            echo "  âš ï¸ No container found"
          fi
        fi
      done
      
      echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
      echo "âœ… All changed apps restarted successfully"
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
  environment:
    name: production
