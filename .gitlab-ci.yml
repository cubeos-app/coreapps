stages:
  - validate
  - deploy
  - restart

validate-compose:
  stage: validate
  image: registry-gitlab.nuclearlighters.net/products/cubeos/coreapps/ci-utils:latest
  tags:
    - multiarch
  script:
    - |
      for dir in */; do
        if [ -f "${dir}appconfig/docker-compose.yml" ]; then
          echo "Checking ${dir}..."
          docker compose -f "${dir}appconfig/docker-compose.yml" config -q || exit 1
        fi
      done
      echo "âœ… All compose files valid"
  rules:
    - if: $CI_COMMIT_BRANCH

shellcheck:
  stage: validate
  image: registry-gitlab.nuclearlighters.net/products/cubeos/coreapps/ci-utils:latest
  tags:
    - multiarch
  script:
    - find . -name "*.sh" -type f -exec shellcheck -x {} \;
  rules:
    - if: $CI_COMMIT_BRANCH
  allow_failure: true

deploy:
  stage: deploy
  tags:
    - deploy
    - arm64
  script:
    - |
      CHANGED_APPS=""
      if [ "$CI_COMMIT_BEFORE_SHA" != "0000000000000000000000000000000000000000" ]; then
        CHANGED_APPS=$(git diff --name-only "$CI_COMMIT_BEFORE_SHA" "$CI_COMMIT_SHA" 2>/dev/null | grep -E '^[^/]+/appconfig/' | cut -d'/' -f1 | sort -u | tr '\n' ' ' || true)
      fi
      echo "Changed apps: ${CHANGED_APPS:-none detected}"
      
      for dir in */; do
        if [ -d "${dir}appconfig" ]; then
          mkdir -p "/cubeos/coreapps/${dir}appconfig"
          cp -r "${dir}appconfig/"* "/cubeos/coreapps/${dir}appconfig/"
        fi
      done
      
      for f in *.sh; do
        [ -f "$f" ] && cp "$f" /cubeos/coreapps/ && chmod +x /cubeos/coreapps/"$f"
      done
      
      echo "$CHANGED_APPS" > changed_apps.txt
      echo "âœ… Synced to /cubeos/coreapps/"
  artifacts:
    paths:
      - changed_apps.txt
    expire_in: 10 minutes
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
  environment:
    name: production

restart-changed:
  stage: restart
  tags:
    - deploy
    - arm64
  needs:
    - deploy
  script:
    - |
      CHANGED_APPS=$(cat changed_apps.txt 2>/dev/null | tr -d '\n' || true)
      
      if [ -z "$CHANGED_APPS" ]; then
        echo "No app changes detected, skipping restart"
        exit 0
      fi
      
      echo "ðŸ”„ Changed apps: $CHANGED_APPS"
      
      # Separate pihole from other apps - restart it LAST
      OTHER_APPS=$(echo "$CHANGED_APPS" | tr ' ' '\n' | grep -v pihole | tr '\n' ' ')
      HAS_PIHOLE=$(echo "$CHANGED_APPS" | grep -c pihole || true)
      
      # Restart non-pihole apps first
      for app in $OTHER_APPS; do
        COMPOSE_FILE="/cubeos/coreapps/${app}/appconfig/docker-compose.yml"
        if [ -f "$COMPOSE_FILE" ]; then
          echo "â”€â”€ $app â”€â”€"
          cd "/cubeos/coreapps/${app}/appconfig"
          docker compose down --remove-orphans 2>/dev/null || true
          docker compose up -d
          sleep 5
          CONTAINER=$(docker compose ps -q 2>/dev/null | head -1)
          if [ -n "$CONTAINER" ]; then
            STATUS=$(docker inspect --format='{{.State.Status}}' "$CONTAINER" 2>/dev/null)
            echo "  Status: $STATUS"
            [ "$STATUS" != "running" ] && docker logs "$CONTAINER" --tail 10 && exit 1
          fi
          echo "  âœ… OK"
        fi
      done
      
      # Restart pihole LAST (if changed)
      if [ "$HAS_PIHOLE" -gt 0 ]; then
        echo "â”€â”€ pihole (restarting last - DNS will briefly drop) â”€â”€"
        cd "/cubeos/coreapps/pihole/appconfig"
        docker compose down --remove-orphans 2>/dev/null || true
        docker compose up -d
        
        # Wait for Pi-hole to be healthy
        echo "  Waiting for Pi-hole DNS..."
        for i in $(seq 1 30); do
          if docker exec cubeos-pihole pihole-FTL --config dhcp.active 2>/dev/null | grep -q "true"; then
            echo "  âœ… Pi-hole healthy"
            break
          fi
          sleep 2
        done
      fi
      
      echo "âœ… Done"
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
  environment:
    name: production
