# =============================================================================
# CubeOS Coreapps Pipeline - Validate, Build, Deploy
# =============================================================================
stages:
  - validate
  - build
  - package
  - deploy
  - restart

variables:
  CUBEOS_SUBNET: "10.42.24.0/24"
  CUBEOS_GATEWAY: "10.42.24.1"
  CUBEOS_DOMAIN: "cubeos.cube"
  # Service classification
  COMPOSE_SERVICES: "pihole npm cubeos-hal"
  STACK_SERVICES: "registry cubeos-api cubeos-dashboard dozzle ollama chromadb"
  # HAL image
  HAL_IMAGE: "ghcr.io/cubeos-app/hal"
  BUILDER_IMAGE: "ghcr.io/cubeos-app/api-builder:latest"

validate-compose:
  stage: validate
  image: registry-gitlab.nuclearlighters.net/products/cubeos/coreapps/ci-utils:latest
  tags:
    - multiarch
  script:
    - |
      # Create dummy env files for validation (real files are on Pi)
      mkdir -p /cubeos/config
      touch /cubeos/config/defaults.env
      touch /cubeos/config/secrets.env
      
      for dir in */; do
        if [ -f "${dir}appconfig/docker-compose.yml" ]; then
          echo "Checking ${dir}..."
          docker compose -f "${dir}appconfig/docker-compose.yml" config -q || exit 1
        fi
      done
      echo "âœ… All compose files valid"
  rules:
    - if: $CI_COMMIT_BRANCH

shellcheck:
  stage: validate
  image: registry-gitlab.nuclearlighters.net/products/cubeos/coreapps/ci-utils:latest
  tags:
    - multiarch
  script:
    - find . -name "*.sh" -type f -exec shellcheck -x {} \;
  rules:
    - if: $CI_COMMIT_BRANCH
  allow_failure: true

# -----------------------------------------------------------------------------
# BUILD HAL - Compile Go binary for both architectures
# -----------------------------------------------------------------------------
build-hal:
  stage: build
  tags: [multiarch]
  image: ${BUILDER_IMAGE}
  script:
    - cp -r cubeos-hal/src/. /app/
    - cd /app
    - go mod download
    - GOOS=linux GOARCH=arm64 CGO_ENABLED=0 go build -ldflags="-s -w" -o cubeos-hal-arm64 ./cmd/cubeos-hal/
    - GOOS=linux GOARCH=amd64 CGO_ENABLED=0 go build -ldflags="-s -w" -o cubeos-hal-amd64 ./cmd/cubeos-hal/
    - cp cubeos-hal-arm64 cubeos-hal-amd64 ${CI_PROJECT_DIR}/
    - ls -lh ${CI_PROJECT_DIR}/cubeos-hal-*
  artifacts:
    paths:
      - cubeos-hal-arm64
      - cubeos-hal-amd64
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      changes:
        - cubeos-hal/**/*

# -----------------------------------------------------------------------------
# PACKAGE HAL - Build multi-arch Docker image and push to ghcr.io
# -----------------------------------------------------------------------------
package-hal:
  stage: package
  tags: [multiarch]
  image: docker:24
  needs:
    - job: build-hal
      optional: true
  before_script:
    - echo "$GHCR_TOKEN" | docker login ghcr.io -u "$GHCR_USER" --password-stdin
    - docker buildx create --name halbuilder --driver docker-container --use
    - docker buildx inspect --bootstrap
  script:
    - |
      cd cubeos-hal/src
      docker buildx build --no-cache \
        --platform linux/amd64,linux/arm64 \
        --push \
        -t ${HAL_IMAGE}:${CI_COMMIT_SHORT_SHA} \
        -t ${HAL_IMAGE}:latest \
        .
    - echo "âœ… Pushed multi-arch ${HAL_IMAGE}:${CI_COMMIT_SHORT_SHA}"
  after_script:
    - docker buildx rm halbuilder || true
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      changes:
        - cubeos-hal/**/*

deploy:
  stage: deploy
  tags:
    - deploy
    - arm64
  script:
    - |
      # Detect changed apps
      CHANGED_APPS=""
      if [ "$CI_COMMIT_BEFORE_SHA" != "0000000000000000000000000000000000000000" ]; then
        CHANGED_APPS=$(git diff --name-only "$CI_COMMIT_BEFORE_SHA" "$CI_COMMIT_SHA" 2>/dev/null \
          | grep -E '^[^/]+/(appconfig|src)/' \
          | cut -d'/' -f1 \
          | sort -u \
          | tr '\n' ' ' \
          | sed 's/ $//' || true)
      fi
      
      # Fallback: if no changes detected but this is a new commit, check all dirs
      if [ -z "$CHANGED_APPS" ]; then
        echo "âš ï¸  No changes detected via git diff, checking for new apps..."
        for dir in */; do
          app="${dir%/}"
          if [ -d "${dir}appconfig" ] && [ ! -d "/cubeos/coreapps/${app}" ]; then
            CHANGED_APPS="$CHANGED_APPS $app"
          fi
        done
        CHANGED_APPS=$(echo "$CHANGED_APPS" | xargs)
      fi
      
      echo "ðŸ“¦ Changed apps: ${CHANGED_APPS:-none}"
      
      # Sync ALL configs and source (idempotent)
      for dir in */; do
        if [ -d "${dir}appconfig" ]; then
          mkdir -p "/cubeos/coreapps/${dir}appconfig"
          mkdir -p "/cubeos/coreapps/${dir}appdata"
          rsync -a --delete "${dir}appconfig/" "/cubeos/coreapps/${dir}appconfig/"
          
          # Also sync src/ if it exists (for buildable apps)
          if [ -d "${dir}src" ]; then
            mkdir -p "/cubeos/coreapps/${dir}src"
            rsync -a --delete "${dir}src/" "/cubeos/coreapps/${dir}src/"
          fi
          
          # Sync appdata if it exists (for DNS configs, etc)
          if [ -d "${dir}appdata" ]; then
            rsync -a "${dir}appdata/" "/cubeos/coreapps/${dir}appdata/"
          fi
        fi
      done
      
      # Sync defaults.env
      [ -f defaults.env ] && cp defaults.env /cubeos/coreapps/
      
      # Ensure config directory structure
      mkdir -p /cubeos/config/vpn/{wireguard,openvpn}
      mkdir -p /cubeos/data/registry
      
      # Copy defaults.env to config if not exists
      if [ ! -f /cubeos/config/defaults.env ]; then
        cp defaults.env /cubeos/config/defaults.env
      fi
      
      # Create empty secrets.env if not exists
      if [ ! -f /cubeos/config/secrets.env ]; then
        touch /cubeos/config/secrets.env
        chmod 600 /cubeos/config/secrets.env
      fi
      
      # Sync scripts directory
      if [ -d "scripts" ]; then
        mkdir -p /cubeos/coreapps/scripts
        rsync -a --delete scripts/ /cubeos/coreapps/scripts/
        chmod +x /cubeos/coreapps/scripts/*.sh 2>/dev/null || true
        
        # Install watchdog systemd files if install script exists
        if [ -f "/cubeos/coreapps/scripts/install-watchdog.sh" ]; then
          echo "ðŸ“¦ Installing watchdog systemd files..."
          /cubeos/coreapps/scripts/install-watchdog.sh
        fi
      fi
      
      # Sync root-level scripts
      for f in *.sh; do
        [ -f "$f" ] && cp "$f" /cubeos/coreapps/ && chmod +x /cubeos/coreapps/"$f"
      done
      
      # Write changed apps (space-separated)
      echo "$CHANGED_APPS" > changed_apps.txt
      echo "âœ… Synced to /cubeos/coreapps/"
  artifacts:
    paths:
      - changed_apps.txt
    expire_in: 10 minutes
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
  environment:
    name: production

restart-changed:
  stage: restart
  tags:
    - deploy
    - arm64
  needs:
    - deploy
    - job: package-hal
      optional: true
  before_script:
    - echo "$GHCR_TOKEN" | docker login ghcr.io -u "$GHCR_USER" --password-stdin
  script:
    - |
      set -e
      
      CHANGED_APPS=$(cat changed_apps.txt 2>/dev/null | xargs || true)
      
      if [ -z "$CHANGED_APPS" ]; then
        echo "âœ… No app changes detected, skipping restart"
        exit 0
      fi
      
      echo "ðŸ”„ Apps to restart: $CHANGED_APPS"
      
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # DNS Health Check - ensure we can resolve Docker Hub
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      echo "ðŸŒ Checking DNS resolution..."
      DNS_OK=false
      for attempt in 1 2 3; do
        if getent hosts registry-1.docker.io >/dev/null 2>&1; then
          DNS_OK=true
          break
        fi
        echo "  DNS attempt $attempt failed, waiting..."
        sleep 5
      done
      
      if [ "$DNS_OK" = "false" ]; then
        echo "âŒ DNS resolution failed - is Pi-hole running?"
        echo "   Run: cd /cubeos/coreapps/pihole/appconfig && docker compose up -d"
        exit 1
      fi
      echo "  âœ… DNS OK"
      
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Ensure Swarm is initialized
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      if ! docker info 2>/dev/null | grep -q "Swarm: active"; then
        echo "ðŸ Initializing Docker Swarm..."
        docker swarm init --advertise-addr 10.42.24.1 --task-history-limit 1 2>/dev/null || true
      fi
      
      # Ensure overlay network exists with SWARM scope (not local)
      NETWORK_SCOPE=$(docker network inspect cubeos-network --format '{{.Scope}}' 2>/dev/null || echo "none")
      if [ "$NETWORK_SCOPE" = "local" ]; then
        echo "ðŸŒ Removing local cubeos-network (wrong scope)..."
        docker network rm cubeos-network 2>/dev/null || true
        NETWORK_SCOPE="none"
      fi
      if [ "$NETWORK_SCOPE" = "none" ]; then
        echo "ðŸŒ Creating cubeos-network overlay (swarm scope)..."
        docker network create --driver overlay --attachable --subnet 10.42.25.0/24 cubeos-network
      fi
      
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Classify apps by deployment type
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      COMPOSE_APPS=""
      STACK_APPS=""
      HAS_PIHOLE=false
      
      for app in $CHANGED_APPS; do
        case "$app" in
          pihole)
            HAS_PIHOLE=true
            ;;
          npm|cubeos-hal)
            COMPOSE_APPS="$COMPOSE_APPS $app"
            ;;
          registry|cubeos-api|cubeos-dashboard|dozzle|ollama|chromadb)
            STACK_APPS="$STACK_APPS $app"
            ;;
          *)
            # Unknown apps - try compose first
            COMPOSE_APPS="$COMPOSE_APPS $app"
            ;;
        esac
      done
      COMPOSE_APPS=$(echo "$COMPOSE_APPS" | xargs)
      STACK_APPS=$(echo "$STACK_APPS" | xargs)
      
      echo "ðŸ“¦ Compose apps: ${COMPOSE_APPS:-none}"
      echo "ðŸ Swarm stacks: ${STACK_APPS:-none}"
      echo "ðŸ”Œ Pi-hole: $HAS_PIHOLE"
      
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Deploy COMPOSE apps (npm, cubeos-hal, and unknown apps)
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      for app in $COMPOSE_APPS; do
        COMPOSE_FILE="/cubeos/coreapps/${app}/appconfig/docker-compose.yml"
        if [ ! -f "$COMPOSE_FILE" ]; then
          echo "âš ï¸  Skipping $app (no docker-compose.yml)"
          continue
        fi
        
        echo "â”€â”€ $app (compose) â”€â”€"
        cd "/cubeos/coreapps/${app}/appconfig"
        
        echo "  ðŸ›‘ Stopping existing..."
        docker rm -f "cubeos-${app}" 2>/dev/null || true
        docker compose down --remove-orphans 2>/dev/null || true
        
        # Pull latest image (HAL image was just pushed by package-hal)
        echo "  ðŸ“¥ Pulling..."
        timeout 120 docker compose pull 2>&1 || echo "  âš ï¸  Pull failed, using cached..."
        
        echo "  ðŸš€ Starting..."
        docker compose up -d --pull always
        
        # Health check
        sleep 3
        CONTAINER=$(docker compose ps -q 2>/dev/null | head -1)
        if [ -n "$CONTAINER" ]; then
          for i in $(seq 1 10); do
            STATUS=$(docker inspect --format='{{.State.Status}}' "$CONTAINER" 2>/dev/null || echo "unknown")
            if [ "$STATUS" = "running" ]; then
              echo "  âœ… $app running"
              break
            fi
            [ "$i" -eq 10 ] && echo "  âš ï¸  $app status: $STATUS"
            sleep 3
          done
        else
          echo "  âœ… $app started"
        fi
      done
      
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Deploy SWARM stacks
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      for app in $STACK_APPS; do
        COMPOSE_FILE="/cubeos/coreapps/${app}/appconfig/docker-compose.yml"
        if [ ! -f "$COMPOSE_FILE" ]; then
          echo "âš ï¸  Skipping $app (no docker-compose.yml)"
          continue
        fi
        
        echo "â”€â”€ $app (swarm) â”€â”€"
        
        # Remove existing stack and stale networks
        echo "  ðŸ›‘ Removing existing stack..."
        docker stack rm "$app" 2>/dev/null || true
        docker network rm "${app}_default" 2>/dev/null || true
        
        # Wait for cleanup
        sleep 3
        
        # Deploy stack with ARM64 workaround
        echo "  ðŸš€ Deploying stack..."
        docker stack deploy \
          -c "$COMPOSE_FILE" \
          --resolve-image=never \
          "$app"
        
        # Wait and check replicas
        sleep 5
        REPLICAS=$(docker stack services "$app" --format "{{.Replicas}}" 2>/dev/null | head -1 || echo "0/0")
        echo "  ðŸ“Š Replicas: $REPLICAS"
        
        # Wait for service to be ready
        for i in $(seq 1 12); do
          REPLICAS=$(docker stack services "$app" --format "{{.Replicas}}" 2>/dev/null | head -1 || echo "0/0")
          if echo "$REPLICAS" | grep -qE "^1/1$|^[0-9]+/[0-9]+$" && [ "$REPLICAS" != "0/1" ]; then
            RUNNING=$(echo "$REPLICAS" | cut -d'/' -f1)
            DESIRED=$(echo "$REPLICAS" | cut -d'/' -f2)
            if [ "$RUNNING" = "$DESIRED" ] && [ "$RUNNING" != "0" ]; then
              echo "  âœ… $app running ($REPLICAS)"
              break
            fi
          fi
          [ "$i" -eq 12 ] && echo "  âš ï¸  $app may still be starting ($REPLICAS)"
          sleep 5
        done
      done
      
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Restart pihole LAST (if changed) - DNS will briefly drop
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      if [ "$HAS_PIHOLE" = "true" ]; then
        echo ""
        echo "â”€â”€ pihole (compose - DNS will briefly drop) â”€â”€"
        cd "/cubeos/coreapps/pihole/appconfig"
        
        echo "  ðŸ›‘ Stopping existing..."
        docker rm -f cubeos-pihole 2>/dev/null || true
        docker compose down --remove-orphans 2>/dev/null || true
        
        echo "  ðŸ“¥ Pulling..."
        docker compose pull 2>&1 || true
        
        echo "  ðŸš€ Starting..."
        docker compose up -d --pull always
        
        echo "  Waiting for Pi-hole DNS..."
        for i in $(seq 1 30); do
          if getent hosts google.com >/dev/null 2>&1; then
            echo "  âœ… Pi-hole DNS responding"
            break
          fi
          [ "$i" -eq 30 ] && echo "  âš ï¸  Pi-hole may still be starting..."
          sleep 2
        done
      fi
      
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Final status
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      echo ""
      echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      echo "ðŸ“Š Final Status"
      echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      echo ""
      echo "COMPOSE CONTAINERS:"
      docker ps --format "table {{.Names}}\t{{.Status}}" 2>/dev/null | grep -E "cubeos-|NAME" || echo "  None"
      echo ""
      echo "SWARM STACKS:"
      docker stack ls 2>/dev/null || echo "  None"
      echo ""
      echo "âœ… Restart complete"
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
  environment:
    name: production
